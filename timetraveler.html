<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Time Traveler</title>
    <script src="https://aframe.io/releases/0.7.1/aframe.min.js"></script>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            background-color: #050505; 
            color: white; 
            font-family: sans-serif;
        }
        
        /* ギャラリー全体を覆うUI（A-FRAMEの上に被せる「幕」） */
        #gallery-ui {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000; 
            background-color: #050505;
            display: block;
        }

        #controls { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            z-index: 100; 
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 8px;
        }
        select, button {
            padding: 8px 12px;
            font-size: 16px;
            margin-right: 10px;
            cursor: pointer;
        }

        #nav-buttons { 
            position: absolute; 
            bottom: 40px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 100; 
            display: none;
        }
        #nav-buttons button {
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 30px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            color: #111;
            margin: 0 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: background 0.2s;
        }

        #tunnel-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            perspective: 800px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        #tunnel {
            position: relative;
            transform-style: preserve-3d;
        }
        
        .img-card {
            position: absolute;
            max-width: 350px;
            max-height: 350px;
            top: 50%;
            left: 50%;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.8);
            transition: transform 0.8s ease-in-out, opacity 0.5s ease-in-out;
            cursor: pointer;
            z-index: 10;
        }

        /* 閉じるボタン専用のUI */
        #custom-close-ui {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: none; 
        }

        .ui-btn {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: 2px solid white;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }
        .ui-btn:active {
            background: white;
            color: black;
        }

        /* --- 流れ星用のスタイル --- */
        .shooting-star {
            position: absolute;
            width: 8px;  /* ★ 3pxから8pxに大きくしました */
            height: 8px; /* ★ 3pxから8pxに大きくしました */
            background-color: #ffffff;
            border-radius: 50%;
            /* ★ 光の拡散も少し大きく・明るくしました */
            box-shadow: 0 0 20px 6px rgba(255, 255, 255, 0.9);
            pointer-events: none; /* クリックの邪魔にならないようにする */
            z-index: 1; /* 画像より奥から発生させるためZインデックスを下げる */
        }
    </style>
</head>
<body>

<div id="gallery-ui">
    <div id="controls">
        <select id="folder-select">
            <option value="sample">サンプル画像</option>
            <option value="local">パソコン内のフォルダを選択...</option>
        </select>
        <button onclick="handleLoad()">表示</button>
        <input type="file" id="folder-input" webkitdirectory directory multiple style="display: none;">
    </div>

    <div id="nav-buttons">
        <button onclick="moveFront()">前</button>
        <button onclick="moveBack()">後</button>
    </div>

    <div id="tunnel-container">
        <div id="tunnel"></div>
    </div>
</div>

<div id="custom-close-ui">
    <button class="ui-btn" onclick="closeViewer()">閉じる &times;</button>
</div>

<a-scene id="scene" style="position: absolute; top: 0; left: 0; z-index: -1; visibility: hidden;">
    <a-entity camera look-controls position="0 1.6 0"></a-entity>
    <a-sky id="vr-sky" src=""></a-sky>
</a-scene>

<script>
    const SAMPLE_IMAGES = [
        "./img360/2013.png",
        "./img360/2004.png",
        "./img360/1991.png",
        "./img360/1975.png",
        "./img360/1968.png",
        "./img360/1966.png",
        "./img360/1960.png",
        "./img360/1956.png",
        "./img360/1955.png",
        "./img360/1954.png",
        "./img360/1953.png",
        "./img360/1949.png",
        "./img360/1935.png",
        "./img360/1917.png",
    ];

    let images = [];
    let currentIndex = 0;
    const Z_GAP = 500;       
    const TUNNEL_RADIUS = 350; 

    function handleLoad() {
        const mode = document.getElementById('folder-select').value;
        if (mode === 'sample') {
            images = [...SAMPLE_IMAGES];
            startViewer();
        } else {
            document.getElementById('folder-input').click();
        }
    }

    document.getElementById('folder-input').addEventListener('change', function(event) {
        const files = Array.from(event.target.files).filter(file => file.type.startsWith('image/'));
        if (files.length === 0) return;
        files.sort((a, b) => a.lastModified - b.lastModified);
        images = files.map(file => URL.createObjectURL(file));
        startViewer();
    });

    function startViewer() {
        currentIndex = 0;
        document.getElementById('nav-buttons').style.display = 'block';
        const tunnel = document.getElementById('tunnel');
        tunnel.innerHTML = '';
        
        images.forEach((url, i) => {
            const img = document.createElement('img');
            img.src = url;
            img.className = 'img-card';
            
            const angle = i * (Math.PI / 2.5); 
            const x = Math.cos(angle) * TUNNEL_RADIUS;
            const y = Math.sin(angle) * TUNNEL_RADIUS;
            const z = -i * Z_GAP;
            
            img.style.transform = `translate(-50%, -50%) translate3d(${x}px, ${y}px, ${z}px)`;
            img.style.opacity = (i < currentIndex) ? '0' : '1';
            img.style.pointerEvents = (i < currentIndex) ? 'none' : 'auto';
            
            img.onclick = () => openFullscreen(url);
            tunnel.appendChild(img);
        });
    }

    function moveBack() {
        if (currentIndex < images.length - 1) { currentIndex++; updatePositions(); }
    }

    function moveFront() {
        if (currentIndex > 0) { currentIndex--; updatePositions(); }
    }

    function updatePositions() {
        const cards = document.querySelectorAll('.img-card');
        cards.forEach((card, i) => {
            const angle = i * (Math.PI / 2.5);
            const x = Math.cos(angle) * TUNNEL_RADIUS;
            const y = Math.sin(angle) * TUNNEL_RADIUS;
            const currentZ = -(i - currentIndex) * Z_GAP;
            
            card.style.transform = `translate(-50%, -50%) translate3d(${x}px, ${y}px, ${currentZ}px)`;
            card.style.opacity = (i < currentIndex) ? '0' : '1';
            card.style.pointerEvents = (i < currentIndex) ? 'none' : 'auto';
        });
    }

    function openFullscreen(url) {
        document.getElementById('gallery-ui').style.display = 'none';
        document.getElementById('custom-close-ui').style.display = 'block';
        
        const scene = document.getElementById('scene');
        document.getElementById('vr-sky').setAttribute('src', url);
        
        scene.style.zIndex = '10';
        scene.style.visibility = 'visible';
        
        if (scene.resize) {
            scene.resize();
        }
    }

    function closeViewer() {
        const scene = document.getElementById('scene');
        
        if (scene && scene.is('vr-mode')) {
            scene.exitVR();
        }
        
        scene.style.zIndex = '-1';
        scene.style.visibility = 'hidden';
        document.getElementById('vr-sky').setAttribute('src', '');
        
        document.getElementById('custom-close-ui').style.display = 'none';
        document.getElementById('gallery-ui').style.display = 'block';
    }

    // --- ここから流れ星エフェクトの処理 ---
    function spawnShootingStar() {
        // VRプレビュー画面を開いている時は星を作らない
        const galleryUI = document.getElementById('gallery-ui');
        if (galleryUI.style.display === 'none') return;

        const star = document.createElement('div');
        star.className = 'shooting-star';
        
        // トンネルコンテナの中に星を追加
        document.getElementById('tunnel-container').appendChild(star);

        // 中央を起点とする
        star.style.top = '50%';
        star.style.left = '50%';

        // X軸とY軸のランダムな位置（画面いっぱいに散らばるように）
        const startX = (Math.random() - 0.5) * 3000;
        const startY = (Math.random() - 0.5) * 3000;
        
        // Z軸の移動: 画面の奥深く（マイナス）から、カメラを通り過ぎる手前（プラス）へ
        const startZ = -4000;
        const endZ = 1000;

        // 星が流れるスピード（1秒〜2.5秒）
        const duration = 1000 + Math.random() * 1500;

        // アニメーションの実行
        const animation = star.animate([
            // 発生時は透明
            { transform: `translate(-50%, -50%) translate3d(${startX}px, ${startY}px, ${startZ}px)`, opacity: 0 },
            // 少し進んだらパッと明るくなる
            { transform: `translate(-50%, -50%) translate3d(${startX}px, ${startY}px, ${startZ + 500}px)`, opacity: 1, offset: 0.1 },
            // 手前に来たら消える
            { transform: `translate(-50%, -50%) translate3d(${startX}px, ${startY}px, ${endZ}px)`, opacity: 0 }
        ], {
            duration: duration,
            easing: 'ease-in' // 手前に来るにつれてスピード感が増すように
        });

        // 通り過ぎたらHTMLから要素を削除して軽くする
        animation.onfinish = () => {
            star.remove();
        };
    }

    // 60ミリ秒に1回、新しい星を発生させる
    setInterval(spawnShootingStar, 60);

</script>
</body>
</html>